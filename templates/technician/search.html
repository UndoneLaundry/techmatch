{% extends "base.html" %}
{% block title %}Find Jobs | TechMatch{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h2 class="h4 mb-1">Find Jobs</h2>
      <div class="text-muted small">Browse available jobs and sign up.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('technician.dashboard') }}">Back to Dashboard</a>
    </div>
  </div>

  <!-- Centered search bar (content area, not navbar) -->
  <div class="row justify-content-center mb-4">
    <div class="col-12 col-md-8 col-lg-6">
      <input
        id="jobSearchInput"
        type="search"
        class="form-control"
        placeholder="Search by job category..."
        aria-label="Search by job category"
      />
    </div>
  </div>

  <div class="row g-3" id="jobsGrid">
    {% for j in jobs %}
      <div class="col-12 col-lg-6">
        <div class="card h-100 job-card" data-search="{{ (j.service_category ~ ' ' ~ j.title ~ ' ' ~ (j.location or ''))|lower|e }}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <h3 class="h6 mb-1">{{ j.title }}</h3>
                <div class="text-muted small">{{ j.service_category }}{% if j.location %} ‚Ä¢ {{ j.location }}{% endif %}</div>
              </div>
              <span class="badge text-bg-info">{{ j.status }}</span>
            </div>

            {% if j.description %}<p class="mt-2 mb-2">{{ j.description|truncate(100) }}</p>{% endif %}

            <div class="small text-muted mb-3">
              Rate: ${{ j.hourly_rate_min }}‚Äì${{ j.hourly_rate_max }}/hr
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" type="button"
                      onclick='viewJobDetails({{ j|tojson|safe }})'>
                View Details
              </button>
              
              {% if j.id in applied_job_ids %}
                <button class="btn btn-sm btn-outline-secondary" type="button" disabled>Already Signed Up</button>
              {% else %}
                <button class="btn btn-sm btn-primary" type="button"
                        onclick='openApplyModal({{ j.id }}, {{ j.title|tojson }})'>
                  Sign Up
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="col-12">
        <div class="text-muted">No jobs available.</div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Apply Modal -->
<div class="modal fade" id="applyModal" tabindex="-1" aria-labelledby="applyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="applyModalLabel">Sign up for job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 text-muted small" id="applyJobTitle"></div>
        <p class="mb-0">Confirm you want to sign up for this job.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmApplyBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- View Job Details Modal -->
<div class="modal fade" id="viewJobModal" tabindex="-1" aria-labelledby="viewJobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewJobModalLabel">Job Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="viewJobContent">
        <!-- Job details will be populated here -->
        <div class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_head %}
{{ super() }}
<style>
/* Task list styling */
.tasks-list {
  margin-top: 1rem;
}

.task-item {
  margin-bottom: 1.25rem;
  padding-left: 1rem;
  border-left: 3px solid #0d6efd;
}

.task-item:last-child {
  margin-bottom: 0;
}

.task-title {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.25rem;
  color: #212529;
}

.task-description {
  font-size: 0.9rem;
  color: #6c757d;
  line-height: 1.5;
}

/* Job section styling */
.job-section {
  margin-bottom: 2rem;
}

.job-section-title {
  font-weight: 600;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #e9ecef;
  color: #212529;
}

/* Info grid styling */
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
  background-color: #f8f9fa;
  padding: 1rem;
  border-radius: 0.5rem;
}

.info-item {
  padding: 0.5rem;
}

.info-label {
  font-size: 0.75rem;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.25rem;
}

.info-value {
  font-weight: 500;
  font-size: 1rem;
  color: #212529;
}

/* Description box styling */
.description-box {
  background-color: #f8f9fa;
  padding: 1rem;
  border-radius: 0.5rem;
  line-height: 1.6;
}

/* Customer info styling */
.customer-info {
  background-color: #f8f9fa;
  padding: 1rem;
  border-radius: 0.5rem;
}

.customer-field {
  margin-bottom: 0.75rem;
}

.customer-field:last-child {
  margin-bottom: 0;
}

.customer-label {
  font-size: 0.8rem;
  color: #6c757d;
  margin-bottom: 0.1rem;
}

.customer-value {
  font-weight: 500;
}

/* Materials styling */
.materials-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.material-tag {
  background-color: #e7f1ff;
  color: #0d6efd;
  padding: 0.35rem 0.75rem;
  border-radius: 2rem;
  font-size: 0.9rem;
  font-weight: 500;
}

/* Status badge in modal */
.status-badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 2rem;
  font-size: 0.85rem;
  font-weight: 600;
  margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    window.applyModal = new bootstrap.Modal(document.getElementById('applyModal'));
    window.viewJobModal = new bootstrap.Modal(document.getElementById('viewJobModal'));
  });

  // Apply modal functions
  let _applyJobId = null;

  function openApplyModal(jobId, title){
    _applyJobId = jobId;
    const t = document.getElementById('applyJobTitle');
    if (t) t.textContent = title || ('Job #' + jobId);
    if (window.applyModal) {
      window.applyModal.show();
    }
  }

  async function applyToJob(jobId){
    try {
      const resp = await fetch(`/technician/jobs/${jobId}/apply`, {method:'POST'});
      if (resp.status === 201){
        window.location.reload();
        return;
      }
      if (resp.status === 409){
        alert('You already signed up for this job.');
        return;
      }
      alert('Could not sign up. Please try again.');
    } catch (error) {
      console.error('Error applying to job:', error);
      alert('Network error. Please try again.');
    }
  }

  const confirmBtn = document.getElementById('confirmApplyBtn');
  if (confirmBtn){
    confirmBtn.addEventListener('click', function(){
      if (!_applyJobId) return;
      applyToJob(_applyJobId);
    });
  }

  // View job details function with tasks display
  function viewJobDetails(jobData) {
    try {
      const job = typeof jobData === 'string' ? JSON.parse(jobData) : jobData;
      
      const modalTitle = document.getElementById('viewJobModalLabel');
      const modalContent = document.getElementById('viewJobContent');
      
      if (!modalTitle || !modalContent) {
        console.error('Modal elements not found');
        return;
      }
      
      // Set the title
      modalTitle.textContent = job.title || `Job #${job.id}`;
      
      // Create status badge
      let statusBadge = '';
      if (job.status) {
        let badgeClass = 'secondary';
        const status = job.status.toLowerCase();
        if (status === 'open' || status === 'available') badgeClass = 'success';
        else if (status === 'in progress') badgeClass = 'warning';
        else if (status === 'completed') badgeClass = 'dark';
        statusBadge = `<span class="badge bg-${badgeClass} mb-3">${job.status.toUpperCase()}</span>`;
      }
      
      // Format posted date from created_at
      const postedDate = job.posted_date || job.created_at
        ? new Date(job.posted_date || job.created_at).toLocaleDateString()
        : 'N/A';

      // Compute estimated duration from start_date / end_date (Unix seconds) if available
      let estimatedDuration = 'Not specified';
      if (job.start_date && job.end_date) {
        const days = Math.round((job.end_date - job.start_date) / 86400);
        estimatedDuration = days === 1 ? '1 day' : `${days} days`;
      }

      // Use real tasks from the database only
      const tasks = (job.tasks && job.tasks.length > 0) ? job.tasks : [];
      
      // Generate tasks HTML
      let tasksHtml = '';
      if (tasks.length > 0) {
        tasksHtml = `<div class="job-section"><div class="job-section-title">üìã Job Tasks</div><div class="tasks-list">`;
        tasks.forEach((task, index) => {
          tasksHtml += `<div class="task-item"><div class="task-title">${index + 1}. ${task.title}</div></div>`;
        });
        tasksHtml += `</div></div>`;
      } else {
        tasksHtml = `<div class="job-section"><div class="job-section-title">üìã Job Tasks</div><div class="text-muted">No tasks have been added yet.</div></div>`;
      }
      
      // Generate materials HTML if available
      let materialsHtml = '';
      if (job.materials && job.materials.length > 0) {
        materialsHtml = `
          <div class="job-section">
            <div class="job-section-title">üîß Materials Needed</div>
            <div class="materials-list">
              ${job.materials.map(m => `<span class="material-tag">${m}</span>`).join('')}
            </div>
          </div>
        `;
      }
      
      // Build the main HTML content
      modalContent.innerHTML = `
        ${statusBadge}
        
        <!-- Quick Info Grid -->
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Category</div>
            <div class="info-value">${job.service_category || 'N/A'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Location</div>
            <div class="info-value">${job.location || 'N/A'}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Rate</div>
            <div class="info-value">$${job.hourly_rate_min || '0'}‚Äì$${job.hourly_rate_max || '0'}/hr</div>
          </div>
          <div class="info-item">
            <div class="info-label">Est. Duration</div>
            <div class="info-value">${estimatedDuration}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Posted</div>
            <div class="info-value">${postedDate}</div>
          </div>
        </div>
        
        <!-- Description Section -->
        <div class="job-section">
          <div class="job-section-title">üìù Description</div>
          <div class="description-box">
            ${job.description || 'No description provided.'}
          </div>
        </div>
        
        <!-- Tasks Section -->
        ${tasksHtml}
        
        <!-- Materials Section -->
        ${materialsHtml}
      `;
      
      if (window.viewJobModal) {
        window.viewJobModal.show();
      } else {
        const modalEl = document.getElementById('viewJobModal');
        if (modalEl) {
          window.viewJobModal = new bootstrap.Modal(modalEl);
          window.viewJobModal.show();
        }
      }
    } catch (error) {
      alert('Error displaying job details. Please try again.');
    }
  }

  // Client-side search filter
  const searchInput = document.getElementById('jobSearchInput');
  if (searchInput){
    searchInput.addEventListener('input', function(){
      const q = (searchInput.value || '').trim().toLowerCase();
      const cards = document.querySelectorAll('.job-card');
      cards.forEach((card) => {
        const hay = (card.getAttribute('data-search') || '');
        const show = !q || hay.includes(q);
        const col = card.closest('.col-12');
        if (col) col.style.display = show ? '' : 'none';
      });
    });
  }
</script>
{% endblock %}