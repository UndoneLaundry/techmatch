{% extends "base.html" %}
{% block title %}Job Details | TechMatch{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('business.dashboard') }}">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('business.list_jobs') }}">Jobs</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ job.title }}</li>
    </ol>
  </nav>

  <!-- Page header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h2 class="h4 mb-1">{{ job.title }}</h2>
      <div class="text-muted small">Job #{{ job.id }}</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      {% if job.status == 'COMPLETED' %}
        <span class="badge text-bg-dark fs-6">COMPLETED</span>
      {% elif job.status == 'ACTIVE' %}
        <span class="badge text-bg-success fs-6">ACTIVE</span>
      {% elif job.status == 'PENDING_CONFIRMATION' %}
        <span class="badge text-bg-warning fs-6">PENDING APPROVAL</span>
      {% else %}
        <span class="badge text-bg-primary fs-6">OPEN</span>
        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#deleteJobModal">
          Delete Job
        </button>
      {% endif %}
    </div>
  </div>

  <!-- Job info card -->
  <div class="card mb-4">
    <div class="card-header bg-white">
      <div class="fw-semibold">Job Details</div>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <div class="text-muted small">Description</div>
          <div>{{ job.description }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-muted small">Category</div>
          <div class="fw-semibold">{{ job.service_category }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-muted small">Hourly Rate</div>
          <div class="fw-semibold">${{ job.hourly_rate_min }}&ndash;${{ job.hourly_rate_max }}/hr</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-muted small">Location</div>
          <div class="fw-semibold">{{ job.location or 'Not specified' }}</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-muted small">Assigned Technician</div>
          <div class="fw-semibold">
            {% if job.assigned_technician_id %}ID {{ job.assigned_technician_id }}{% else %}Not yet assigned{% endif %}
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="text-muted small">Estimated Duration</div>
          <div class="fw-semibold">
            {% if job.start_date and job.end_date %}
              {% set days = ((job.end_date - job.start_date) / 86400) | round | int %}
              {{ days }} day{{ 's' if days != 1 else '' }}
            {% else %}
              Not specified
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Applications link -->
  {% if job.status == 'OUTGOING' %}
  <div class="mb-4">
    <a href="{{ url_for('business.list_applications', job_id=job.id) }}" class="btn btn-outline-primary">
      View Applications <span class="badge text-bg-primary ms-1">{{ job.application_count or 0 }}</span>
    </a>
  </div>
  {% endif %}

  <!-- Pending confirmation banner -->
  {% if job.status == 'PENDING_CONFIRMATION' %}
  <div class="border rounded p-3 mb-4 d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div>
      <div class="fw-semibold">Completion request received</div>
      <div class="text-muted small">The technician has marked this job as complete. Review and approve to close it out.</div>
    </div>
    <button class="btn btn-outline-secondary" id="approveJobBtn">Approve Completion</button>
  </div>
  {% endif %}

  <!-- Tasks card -->
  <div class="card">
    <div class="card-header bg-white">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">Tasks</div>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
          + Add Task
        </button>
      </div>
    </div>
    <div class="card-body">
      {% if job.tasks %}
        <div class="row g-2">
          {% for task in job.tasks %}
          <div class="col-12">
            <div class="border rounded p-3 d-flex justify-content-between align-items-center">
              <div class="fw-semibold">{{ task.title }}</div>
              <div class="d-flex align-items-center gap-2">
                {% if task.is_completed %}
                  <span class="badge text-bg-dark">Completed</span>
                {% else %}
                  <span class="badge text-bg-secondary">Pending</span>
                {% endif %}
                <button class="btn btn-sm btn-outline-secondary delete-task-btn"
                        data-task-id="{{ task.id }}"
                        data-task-title="{{ task.title }}">
                  &times;
                </button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">No tasks yet. Add tasks to give the technician a checklist.</div>
      {% endif %}
    </div>
  </div>

</div>

<!-- Add Task Modal (Bootstrap) -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTaskModalLabel">Add Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="taskTitle" class="form-label">Task Title</label>
          <input type="text" class="form-control" id="taskTitle" name="title" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="addTaskSubmitBtn">Add Task</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Job Confirmation Modal -->
<div class="modal fade" id="deleteJobModal" tabindex="-1" aria-labelledby="deleteJobModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteJobModalLabel">Delete Job</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong>{{ job.title }}</strong>?</p>
        <p class="text-muted small mb-0">This will also remove all tasks and applications for this job. This cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{{ url_for('business.delete_job', job_id=job.id) }}" class="m-0">
          <button type="submit" class="btn btn-outline-secondary">Yes, delete job</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Add task
document.getElementById('addTaskSubmitBtn')?.addEventListener('click', async () => {
  const input = document.getElementById('taskTitle');
  const title = input.value.trim();
  if (!title) { input.focus(); return; }

  const formData = new FormData();
  formData.append('title', title);

  const res = await fetch("{{ url_for('business.add_task', job_id=job.id) }}", {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });
  const data = await res.json();
  if (data.success) {
    location.reload();
  } else {
    alert('Error: ' + data.error);
  }
});

// Delete task
document.querySelectorAll('.delete-task-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const taskTitle = btn.dataset.taskTitle;
    if (!confirm(`Delete task "${taskTitle}"?`)) return;
    const taskId = btn.dataset.taskId;
    const res = await fetch(`/business/jobs/{{ job.id }}/tasks/${taskId}/delete`, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const data = await res.json();
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Could not delete task.'));
    }
  });
});

// Approve job
document.getElementById('approveJobBtn')?.addEventListener('click', async () => {
  if (!confirm('Approve completion of this job?')) return;
  const res = await fetch("{{ url_for('business.approve_job', job_id=job.id) }}", {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' }
  });
  const data = await res.json();
  if (data.success) {
    location.reload();
  } else {
    alert('Error: ' + data.error);
  }
});
</script>
{% endblock %}